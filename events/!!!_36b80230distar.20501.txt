namespace = distar
planet_event = {
    id = distar.20501
    is_triggered_only = yes
    hide_window = yes
    immediate = {
        solar_system = {
            if = {
                limit = {
                    any_system_megastructure = {
                        OR = {
                            is_megastructure_type = gateway_ruined
                            is_megastructure_type = gateway_restored
                            is_megastructure_type = gateway_final
                            is_megastructure_type = lgate_base
                        }
                    }
                }
                random_system_megastructure = {
                    limit = {
                        OR = {
                            is_megastructure_type = gateway_ruined
                            is_megastructure_type = gateway_restored
                            is_megastructure_type = gateway_final
                            is_megastructure_type = lgate_base
                        }
                    }
                    save_event_target_as = spawning_gateway
                }
            }
            else = {
                root = {
                    save_event_target_as = spawning_gateway
                }
            }
        }
        if = {
            limit = {
                any_system = {
                    exists = owner
                    owner = {
                        is_country_type = default
                        is_at_war = no
                        any_owned_planet = {
                            is_colony = yes
                            NOT = {
                                has_planet_flag = has_been_scanned
                            }
                        }
                    }
                }
            }
            if = {
                limit = {
                    any_system = {
                        exists = owner
                        owner = {
                            is_ai = no
                            is_country_type = default
                            is_at_war = no
                            any_owned_planet = {
                                is_colony = yes
                                NOT = {
                                    has_planet_flag = has_been_scanned
                                }
                            }
                        }
                    }
                }
                closest_system = {
                    limit = {
                        exists = owner
                        owner = {
                            is_country_type = default
                            is_at_war = no
                            is_ai = no
                            any_owned_planet = {
                                is_colony = yes
                                NOT = {
                                    has_planet_flag = has_been_scanned
                                }
                            }
                        }
                    }
                    random_system_planet = {
                        limit = {
                            exists = owner
                        }
                        save_event_target_as = new_location
                        solar_system = {
                            set_star_flag = enigmatic_cache_system
                        }
                    }
                }
            }
        }
        else = {
            closest_system = {
                limit = {
                    exists = owner
                    owner = {
                        is_country_type = default
                        is_at_war = no
                        any_owned_planet = {
                            is_colony = yes
                            NOT = {
                                has_planet_flag = has_been_scanned
                            }
                        }
                    }
                }
                random_system_planet = {
                    limit = {
                        exists = owner
                    }
                    save_event_target_as = new_location
                    solar_system = {
                        set_star_flag = enigmatic_cache_system
                    }
                }
            }
        }
        create_country = {
            name = "NAME_enigmatic_cache"
            type = enigmatic_cache
            flag = {
                icon = {
                    category = spherical
                    file = flag_spherical_4.dds
                }
                background = {
                    category = backgrounds
                    file = "00_solid.dds"
                }
                colors = {
                    "black"
                    "black"
                    "null"
                    "null"
                }
            }
            effect = {
                save_global_event_target_as = enigmatic_cache_country
            }
        }
        event_target:enigmatic_cache_country = {
            set_graphical_culture = guardian_01
            create_enigmatic_cache_fleet = yes
        }
        every_country = {
            establish_communications_no_message = event_target:enigmatic_cache_country
        }
    }
}
