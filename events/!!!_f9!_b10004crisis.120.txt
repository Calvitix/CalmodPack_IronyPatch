namespace = crisis
event = {
    id = crisis.120
    hide_window = yes
    is_triggered_only = yes
    trigger = {
        has_global_flag = feral_prethoryn_can_spawn
        any_country = {
            AND = {
                is_country_type = global_event
                check_variable = {
                    which = "feral_prethoryn_spawned"
                    value < 10
                }
            }
        }
        any_system = {
            AND = {
                has_owner = no
                any_system_planet = {
                    has_planet_flag = previously_infested
                }
                NOT = {
                    has_star_flag = feral_prethoryn_system
                }
            }
        }
    }
    immediate = {
        random_list = {
            10 = {
                random_country = {
                    limit = {
                        is_country_type = global_event
                    }
                    change_variable = {
                        which = "feral_prethoryn_spawned"
                        value = 1
                    }
                }
                if = {
                    limit = {
                        NOT = {
                            any_country = {
                                is_country_type = feral_prethoryn
                            }
                        }
                    }
                    random_system = {
                        limit = {
                            has_owner = no
                            any_system_planet = {
                                has_planet_flag = previously_infested
                            }
                            NOR = {
                                has_star_flag = feral_prethoryn_system
                                is_star_class = sc_dn
                            }
                        }
                        set_star_flag = feral_prethoryn_system
                        save_event_target_as = feral_prethoryn_system
                        create_species = {
                            name = "NAME_Prethoryn"
                            plural = "NAME_Prethoryns"
                            adjective = "NAME_Prethoryn"
                            class = SWARM
                            namelist = Prethoryn
                            portrait = random
                            traits = random
                            immortal = yes
                            effect = {
                                save_event_target_as = feral_prethoryn_species
                            }
                        }
                        create_country = {
                            name = "NAME_Feral_Prethoryn"
                            type = "feral_prethoryn"
                            species = event_target:feral_prethoryn_species
                            name_list = "Prethoryn"
                            flag = {
                                icon = {
                                    category = "special"
                                    file = "the_swarm.dds"
                                }
                                background = {
                                    category = "backgrounds"
                                    file = "new_dawn.dds"
                                }
                                colors = {
                                    "red_orange"
                                    "grey"
                                    "null"
                                    "null"
                                }
                            }
                            effect = {
                                save_global_event_target_as = feral_prethoryn
                                create_ship_design = {
                                    design = "NAME_Swarm_Starbase"
                                }
                                add_ship_design = last_created_design
                            }
                        }
                        create_starbase = {
                            size = starbase_swarm
                            owner = event_target:feral_prethoryn
                        }
                        random_system_planet = {
                            feral_prethoryn_garrison_1 = yes
                        }
                        random_system_planet = {
                            feral_prethoryn_garrison_1 = yes
                        }
                        random_system_planet = {
                            feral_prethoryn_garrison_2 = yes
                        }
                        every_country = {
                            establish_communications_no_message = event_target:feral_prethoryn
                        }
                        if = {
                            limit = {
                                NOT = {
                                    has_global_flag = feral_prethoryn_appeared
                                }
                            }
                            every_country = {
                                limit = {
                                    is_ai = no
                                }
                                country_event = {
                                    id = crisis.121
                                }
                            }
                        }
                        set_global_flag = feral_prethoryn_appeared
                    }
                    break = yes
                }
                if = {
                    limit = {
                        any_country = {
                            is_country_type = feral_prethoryn
                        }
                    }
                    random_system = {
                        limit = {
                            has_owner = no
                            any_system_planet = {
                                has_planet_flag = previously_infested
                            }
                            NOR = {
                                has_star_flag = feral_prethoryn_system
                                is_star_class = sc_dn
                            }
                        }
                        set_star_flag = feral_prethoryn_system
                        save_event_target_as = feral_prethoryn_system
                        create_starbase = {
                            size = starbase_swarm
                            owner = event_target:feral_prethoryn
                        }
                        random_system_planet = {
                            feral_prethoryn_garrison_1 = yes
                        }
                        random_system_planet = {
                            feral_prethoryn_garrison_2 = yes
                        }
                    }
                }
            }
            90 = {
            }
        }
    }
}
